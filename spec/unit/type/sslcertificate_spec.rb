#! /usr/bin/env ruby
require 'spec_helper'
require 'openssl'

describe Puppet::Type.type(:sslcertificate) do
  let(:catalog) { Puppet::Resource::Catalog.new }
  let(:www_domain_com_private) do
    <<-RSAKEYDATA
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA2ioyHOr0O+/j7ztapdb9qJl2lmOEOC8u/AwajAJhhZ5NZ9cF
et54WyGx+ou59dKQDgGRB6El5wNzMhwVoVhY6VwJrem/e3UDDhI9trr2Ei+0wZkF
LK/wmTNdZ9RmnZfRL24g/2F/7wphq/akRGPjQjQC7Ev6jXyd3O+o0qqC7diMEd+f
WpZS94Tvacf/7C1q6pvBoxTv+bf37D8hYDi4FM+E7GcykJcMDaeAdu36oCaM9DHj
ZsedOGE5+ggt0Km+Y5rRmphTLtgwfwNGnHV38lOkQc5nXNEXkyj0AwQW0eMurmI5
eP20FLngig4y/s8X5OiYn1LrOW7i0KMj0K0yywIDAQABAoIBACLL+iQ8oWnx8EQX
DnVHHjxHBfAkvVEMzYysDYvpUU6zmhsG47veQgofDLkukiGQTSO+wjgaTuZS2YvT
iOusILpP0Mdpcf4qAqu64xcDKP5rl4QNeRLQmSqGU86cxSU7ssTC5wZ0sagZ2sxH
0ZmK6ROFIjY4RCVPDArSOvYm9i0jQoII/eQSQPHAxQ9bvG9wHhFKtkR4Yg8CWVhH
ZyDHDH7Wbvn6gY19bqYYK80NwMoh9CnWFux+nesiGbLfGunL7TPBoK+ckbT5awEP
RSjSn4uAkj1ll/MwCJpEytNwr3gKhE0eUVa3hfLX2p99OKYRKZQl0tcfE4EnxjcV
pASD2bECgYEA8p4q40E+Dpr7zGSVA9WPWJvjZUfjvF/WQ8f3kQP4YX8oMAvt3zn5
hyaz91Lh5fXwNNSVhVn4Ze5unzvcDAR/leqLSHoc4u74A9zwWJN6CdtHxK8HW3Nd
gjhwY7qrVPEPX3WPM1pP08+obi8HV9JrrfauKbfTNxQFU0twBffdkPkCgYEA5jK+
p77sCvSUh40NqofMo+TaUMSI463CDZ1qhse2LiEBuxcmShsBb/Mm62Q5MjpSNQ7g
pyoiys09vuRCkhbXIpQT9SYiHRDy3Ha4Cjix8wWU7c2bpAc7gVBNg1JHAP9E/xwn
ucHjRhFyZLr8E7DJ/S9QeZunUGozFaJY1F8SVuMCgYEArY2pflFwdAA3+VlGI60E
Us2I2C2Z4mnoGyqTlP/zEMNmWyBdc97D+gMcn+KBSAAraY9cujzG7RuntG6clVgu
cG6MXjdELK3natQEdkhg92YOK8tNBwU6selvtFeXMjcS2SV+X6zOB+W3RcKMjS0v
7AzXP26JQBApUxFWvF439/kCgYBegdLYV3/c95DLHdPQgTQ4zUn8AtQYdUvH/yqu
7usSgSaOwvBLWE78wRznYxxATMVXVyZQOvJRxHVnG5thEtN8NMME0IUM3dp3PJ5O
Q/x6w33jK5iMfROnAWrxUSQpeqO/ALYmgz1llOAcDtBS3S/wLC6j3o2QbClQ5ngF
qIqE9QKBgD+DFd6cc5zeyDNvVLkjcP7OQNs4ftnhZiMZKT8GgqGMw4prQr3VYUSS
2OR7a6YU3qLdBeX7/3w0FFmPVudDm3v0B+gGa6z+waAUP9ctGmHEEKTZHXY9CV3x
FbqDhaZYwLRaQNBmSWUi49bI68c4w4mVOKGPqjPH+k/1p6OpgSz4
-----END RSA PRIVATE KEY-----
RSAKEYDATA
  end
  let(:www_domain_com_certificate) do
    <<-CERTIFICATE
-----BEGIN CERTIFICATE-----
MIIEoTCCA4mgAwIBAgIBAjANBgkqhkiG9w0BAQsFADByMQswCQYDVQQGEwJERTEX
MBUGA1UECgwORG9tYWluLmNvbSBJbmMxFzAVBgNVBAsMDnd3dy5kb21haW4uY29t
MTEwLwYDVQQDDChEb21haW4uY29tIFNIQTIgSGlnaCBBc3N1cmFuY2UgU2VydmVy
IENBMB4XDTE5MDEwNDExMTIxOFoXDTIwMDEwNDExMTIxOFowYzELMAkGA1UEBhMC
VVMxCzAJBgNVBAgMAkNBMRMwEQYDVQQHDApNZW5sbyBQYXJrMRkwFwYDVQQKDBBE
b21haW4uY29tLCBJbmMuMRcwFQYDVQQDDA53d3cuZG9tYWluLmNvbTCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBANoqMhzq9Dvv4+87WqXW/aiZdpZjhDgv
LvwMGowCYYWeTWfXBXreeFshsfqLufXSkA4BkQehJecDczIcFaFYWOlcCa3pv3t1
Aw4SPba69hIvtMGZBSyv8JkzXWfUZp2X0S9uIP9hf+8KYav2pERj40I0AuxL+o18
ndzvqNKqgu3YjBHfn1qWUveE72nH/+wtauqbwaMU7/m39+w/IWA4uBTPhOxnMpCX
DA2ngHbt+qAmjPQx42bHnThhOfoILdCpvmOa0ZqYUy7YMH8DRpx1d/JTpEHOZ1zR
F5Mo9AMEFtHjLq5iOXj9tBS54IoOMv7PF+TomJ9S6zlu4tCjI9CtMssCAwEAAaOC
AU8wggFLMCwGCWCGSAGG+EIBDQQfFh1PcGVuU1NMIEdlbmVyYXRlZCBDZXJ0aWZp
Y2F0ZTAdBgNVHQ4EFgQUEmfAodxrRPxW7pK6M8T4UJvAI/EwHwYDVR0jBBgwFoAU
yDHsYobfbcXMjWRlThhnL75IODswDgYDVR0PAQH/BAQDAgSwMB0GA1UdJQQWMBQG
CCsGAQUFBwMBBggrBgEFBQcDAjA3BgNVHR8EMDAuMCygKqAohiZodHRwOi8vc3Ns
LWNybC5kb21haW4uY29tL2NybHMvc3NsLmNybDAMBgNVHRMBAf8EAjAAMGUGCCsG
AQUFBwEBBFkwVzAmBggrBgEFBQcwAYYaaHR0cDovL3NzbC1vY3NwLmRvbWFpbi5j
b20wLQYIKwYBBQUHMAKGIWh0dHA6Ly9zc2wtYWlhLmRvbWFpbi5jb20vc3NsLmNy
dDANBgkqhkiG9w0BAQsFAAOCAQEAMB8GDJ8A/s9MdBJiDYu2iq6a1KBjT+Qsvz96
IDu4VQzGH+71SqR+gj3as5Qn8pimFngU860R/UObO200MyPxC8tv0h1X7RglsXQ3
qbKD0Fv99azQzto910AC3tf4cYqB+CPjzVgFspFpDh5vXRZ2B0SFznfSbCWEVH88
IulbIAXDU7PINpA8sZrOThYC6srXxZ3UUFdSZNLQQN68F+4qIHWxws63hNSlfd9S
3Od4q4p4JRPu9sok+2w9sKZUIYZ3VQRqlJ1DzujDS1PRVesqy72NZURwG0HOOfjd
GPeZDmweTojU0wqWLYrrVBelsBg8yh5Zuhb870Gdls7/RJZ2XQ==
-----END CERTIFICATE-----
CERTIFICATE
  end
  let(:www_domain_com_certificate_modulus) do
    'DA2A321CEAF43BEFE3EF3B5AA5D6FDA89976966384382F2EFC0C1A8C0261859E4D67D705'\
    '7ADE785B21B1FA8BB9F5D2900E019107A125E70373321C15A15858E95C09ADE9BF7B7503'\
    '0E123DB6BAF6122FB4C199052CAFF099335D67D4669D97D12F6E20FF617FEF0A61ABF6A4'\
    '4463E3423402EC4BFA8D7C9DDCEFA8D2AA82EDD88C11DF9F5A9652F784EF69C7FFEC2D6A'\
    'EA9BC1A314EFF9B7F7EC3F216038B814CF84EC673290970C0DA78076EDFAA0268CF431E3'\
    '66C79D386139FA082DD0A9BE639AD19A98532ED8307F03469C7577F253A441CE675CD117'\
    '9328F4030416D1E32EAE623978FDB414B9E08A0E32FECF17E4E8989F52EB396EE2D0A323'\
    'D0AD32CB'
  end
  let(:www_domain_com_intermediate) do
    <<-CERTIFICATE
-----BEGIN CERTIFICATE-----
MIIETzCCAzegAwIBAgIBATANBgkqhkiG9w0BAQsFADBvMQswCQYDVQQGEwJERTEY
MBYGA1UECgwPRG9tYWluLmNvbSBJbmMuMRcwFQYDVQQLDA53d3cuZG9tYWluLmNv
bTEtMCsGA1UEAwwkRG9tYWluLmNvbSBIaWdoIEFzc3VyYW5jZSBFViBSb290IENB
MB4XDTE5MDEwNDEwNDY0MloXDTIwMDEwNDEwNDY0MlowcjELMAkGA1UEBhMCREUx
FzAVBgNVBAoMDkRvbWFpbi5jb20gSW5jMRcwFQYDVQQLDA53d3cuZG9tYWluLmNv
bTExMC8GA1UEAwwoRG9tYWluLmNvbSBTSEEyIEhpZ2ggQXNzdXJhbmNlIFNlcnZl
ciBDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMWymCU/flUDnmtm
QKMr2jFMmsaHBJ1LGz86+e2J4jj4qapCPkwWdCuX0DkFzNRlcZCQLzvP2UYQXNg8
rTq+QHhmwQbknsno7TE3hBaOWOTBKgDbE1QPyaryNN0O+4RI3Q2KLpdb8aHfyr/Q
rzbweuLmh7jUpB0BrCCxV2XCEViPV+5WH/Lh9yLkisYXanCFV6fmKOTnsJAkK/Nm
CzOrvJjdxtdxDUPEKSfbcoA38W/Ih0/pVcLVWzgTrresL9LLPOWdMzPG+X49gLx7
nsWpMemg+IpYMq6O6gpRcQigWa55EB/wMHOSr4Hn9sX9DL1rurWUOoOZdDOqO2mC
kdfX6/8CAwEAAaOB8jCB7zASBgNVHRMBAf8ECDAGAQH/AgEAMA4GA1UdDwEB/wQE
AwIBhjAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwMgYIKwYBBQUHAQEE
JjAkMCIGCCsGAQUFBzABhhZodHRwOi8vb2NzcC5kb21haW4uY29tMDYGA1UdHwQv
MC0wK6ApoCeGJWh0dHA6Ly9jcmwuZG9tYWluLmNvbS9jcmxzL2dsb2JhbC5jcmww
HQYDVR0OBBYEFMgx7GKG323FzI1kZU4YZy++SDg7MB8GA1UdIwQYMBaAFHMuhPNM
q8tDVXw45TjLO9ycGCuDMA0GCSqGSIb3DQEBCwUAA4IBAQBkRjdVJKyTG+bwKKFl
4xz2c3GKNznvMFjY5CZ5IbAPPQJmugGilI07UFvxVDVimEmiSya7virGAtlV9TM9
a+TJB3LUUKrxmek9xQRf1nSWKEDif3d+ccJ384GmXWb0ImyDS50Li68Hoj6hz8Vg
aeLf7zi0YAQqHzCbWQEokXXVP9SSyfmwT9DnZ1DUd2fL71jNeqwu7VQXH5J63/ub
xVUAwv6jUsAKmFUvvqM8dEIB6zM3xplFIJF5QHwwfqOmJydmrNwj37hFiE2uFw0u
NCOPoS6/Htch8uRSj2UfcuFBtsXMg3RX+e6CTNz49ogTUYtzL8aVR3UBqaf8FrVY
RNae
-----END CERTIFICATE-----
    CERTIFICATE
  end

  it 'check with empty parameters list' do
    params = {
      title: 'namevar',
      catalog: catalog
    }
    expect { described_class.new(params) }.to raise_error Puppet::Error, %r{File paths must be fully qualified, not 'namevar'}
  end

  it 'check with empty parameters and proper title' do
    params = {
      title: '/etc/pki/tls/certs/www.domain.com.pem',
      catalog: catalog
    }
    expect { described_class.new(params) }.to raise_error Puppet::Error, %r{:content property is mandatory for Sslcertificate resource}
  end
end